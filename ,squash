#!/bin/bash

# Git Squash Script
# Squashes all commits on current branch back to base branch (default: main)
# Usage: ./git-squash.sh [base-branch] [--no-verify]

set -e

# Parse arguments
BASE="main"
NO_VERIFY=""

for arg in "$@"; do
    if [ "$arg" = "--no-verify" ]; then
        NO_VERIFY="--no-verify"
    else
        BASE="$arg"
    fi
done

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check if we're on the base branch
if [ "$BRANCH" = "$BASE" ]; then
    echo "Error: Cannot squash $BASE into itself"
    exit 1
fi

# Get the first commit message from the branch
FIRST_MSG=$(git log $BASE..HEAD --format=%B --reverse | head -n 1)

if [ -z "$FIRST_MSG" ]; then
    echo "Error: No commits found between $BASE and $BRANCH"
    exit 1
fi

# Get the merge base
MERGE_BASE=$(git merge-base $BASE HEAD)

echo "Squashing commits from $BASE to $BRANCH..."
echo "Using commit message: $FIRST_MSG"
echo ""

# Confirm before proceeding
read -p "Continue? (y/n) " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted"
    exit 1
fi

# Squash commits
git reset --soft $MERGE_BASE

# Store the original HEAD in case we need to revert
ORIGINAL_HEAD=$(git rev-parse HEAD@{1})

# Try to commit, revert if it fails
if ! git commit $NO_VERIFY -m "$FIRST_MSG"; then
    echo ""
    echo "Error: Commit failed due to git hooks"
    echo "Reverting changes..."
    git reset --hard $ORIGINAL_HEAD
    echo "Reverted to original state"
    exit 1
fi

echo "Commits squashed successfully!"
echo ""

# Push with force-with-lease
read -p "Push to remote with --force-with-lease? (y/n) " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    git push --force-with-lease origin $BRANCH
    echo "Pushed to origin/$BRANCH"
else
    echo "Skipped push. Run manually: git push --force-with-lease origin $BRANCH"
fi
