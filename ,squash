#!/bin/bash

# Git Squash Script
# Squashes all commits on current branch back to base branch (default: main)
# Usage: ./git-squash.sh [base-branch] [--no-verify]
# Requires: gum (https://github.com/charmbracelet/gum)

set -e

# Check if gum is installed
if ! command -v gum &> /dev/null; then
    echo "Error: gum is not installed"
    echo "Install it with: brew install gum"
    exit 1
fi

# Parse arguments
BASE="main"
NO_VERIFY=""

for arg in "$@"; do
    if [ "$arg" = "--no-verify" ]; then
        NO_VERIFY="--no-verify"
    else
        BASE="$arg"
    fi
done

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check if we're on the base branch
if [ "$BRANCH" = "$BASE" ]; then
    gum style --foreground 196 "Error: Cannot squash $BASE into itself"
    exit 1
fi

# Check if base branch exists (try origin/BASE if BASE doesn't exist locally)
if ! git rev-parse --verify "$BASE" &>/dev/null; then
    if git rev-parse --verify "origin/$BASE" &>/dev/null; then
        BASE="origin/$BASE"
    else
        gum style --foreground 196 "Error: Base branch '$BASE' not found (tried local and origin/$BASE)"
        exit 1
    fi
fi

# Get the merge base
MERGE_BASE=$(git merge-base $BASE HEAD)

if [ -z "$MERGE_BASE" ]; then
    gum style --foreground 196 "Error: Could not find common ancestor between $BASE and $BRANCH"
    exit 1
fi

# Get the first commit message from the branch
FIRST_MSG=$(git log $BASE..HEAD --format=%B --reverse | head -n 1)

if [ -z "$FIRST_MSG" ]; then
    gum style --foreground 196 "Error: No commits found between $BASE and $BRANCH"
    exit 1
fi

# Show commit summary
gum style --border rounded --padding "1 2" --margin "1 0" \
    "$(gum style --bold --foreground 212 'Squash Summary')" \
    "" \
    "Base branch: $(gum style --foreground 99 "$BASE")" \
    "Current branch: $(gum style --foreground 99 "$BRANCH")" \
    "Merge base: $(gum style --foreground 240 "${MERGE_BASE:0:8}")" \
    "" \
    "Commit message: $(gum style --foreground 120 "$FIRST_MSG")"

# Confirm before proceeding
if ! gum confirm "Continue with squash?"; then
    gum style --foreground 240 "Aborted"
    exit 1
fi

# Squash commits
gum spin --spinner dot --title "Squashing commits..." -- sleep 0.5
git reset --soft $MERGE_BASE

# Store the original HEAD in case we need to revert
ORIGINAL_HEAD=$(git rev-parse HEAD@{1})

# Try to commit, revert if it fails
if ! git commit $NO_VERIFY -m "$FIRST_MSG"; then
    gum style --foreground 196 "Error: Commit failed due to git hooks"
    gum spin --spinner dot --title "Reverting changes..." -- sleep 0.5
    git reset --hard $ORIGINAL_HEAD
    gum style --foreground 120 "Reverted to original state"
    exit 1
fi

gum style --foreground 120 "✓ Commits squashed successfully!"
echo ""

# Push with force-with-lease
if gum confirm "Push to remote with --force-with-lease?"; then
    gum spin --spinner dot --title "Pushing to origin/$BRANCH..." -- \
        git push --force-with-lease origin $BRANCH
    gum style --foreground 120 "✓ Pushed to origin/$BRANCH"
else
    gum style --foreground 240 "Skipped push. Run manually: git push --force-with-lease origin $BRANCH"
fi
